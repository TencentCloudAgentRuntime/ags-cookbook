# k6-for-custom-tool å‹æµ‹å·¥å…·

è¿™æ˜¯ä¸€ä¸ªåŸºäº [k6](https://k6.io/) çš„ AGS (Agent Sandbox) è‡ªå®šä¹‰å·¥å…·å‹æµ‹æ¡†æ¶ï¼Œæ”¯æŒ **æœ¬åœ°å•æœº (Local)** å’Œ **åˆ†å¸ƒå¼ (Distributed)** ä¸¤ç§è¿è¡Œæ¨¡å¼ã€‚

---

## ç›®å½•

- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å‰ç½®æ¡ä»¶](#å‰ç½®æ¡ä»¶)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
  - [ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–](#ç¬¬ä¸€æ­¥å®‰è£…ä¾èµ–)
  - [ç¬¬äºŒæ­¥ï¼šæ„å»º k6 (å« xk6-ags æ‰©å±•)](#ç¬¬äºŒæ­¥æ„å»º-k6-å«-xk6-ags-æ‰©å±•)
  - [ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡](#ç¬¬ä¸‰æ­¥é…ç½®ç¯å¢ƒå˜é‡)
  - [ç¬¬å››æ­¥ï¼šé…ç½®æµ‹è¯•å‚æ•°](#ç¬¬å››æ­¥é…ç½®æµ‹è¯•å‚æ•°)
  - [ç¬¬äº”æ­¥ï¼šè¿è¡Œæµ‹è¯•](#ç¬¬äº”æ­¥è¿è¡Œæµ‹è¯•)
- [Local vs Distributed æ¨¡å¼å¯¹æ¯”](#local-vs-distributed-æ¨¡å¼å¯¹æ¯”)
- [è¯¦ç»†ä½¿ç”¨æŒ‡å—](#è¯¦ç»†ä½¿ç”¨æŒ‡å—)
  - [Local æ¨¡å¼ (æœ¬åœ°å•æœº)](#local-æ¨¡å¼-æœ¬åœ°å•æœº)
  - [Distributed æ¨¡å¼ (åˆ†å¸ƒå¼é›†ç¾¤)](#distributed-æ¨¡å¼-åˆ†å¸ƒå¼é›†ç¾¤)
- [å¯ç”¨çš„æµ‹è¯•ç”¨ä¾‹](#å¯ç”¨çš„æµ‹è¯•ç”¨ä¾‹)
- [ç›‘æ§ä¸å¯è§†åŒ–](#ç›‘æ§ä¸å¯è§†åŒ–)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## é¡¹ç›®ç»“æ„

```
k6-for-custom-tool/
â”œâ”€â”€ Makefile                    # ä¸»æ„å»ºè„šæœ¬
â”œâ”€â”€ Dockerfile                  # æ„å»º k6 é•œåƒ
â”œâ”€â”€ pkg/
â”‚   â””â”€â”€ xk6-ags/                # k6 AGS æ‰©å±•æ¨¡å—
â”‚       â”œâ”€â”€ .env.example        # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”‚       â””â”€â”€ *.go                # Go æºç 
â”œâ”€â”€ tests/                      # æµ‹è¯•ç”¨ä¾‹
â”‚   â”œâ”€â”€ helloworld/             # å…¥é—¨ç¤ºä¾‹
â”‚   â”œâ”€â”€ ags-control-panel-load-test/   # æ§åˆ¶é¢å‹æµ‹
â”‚   â””â”€â”€ ags-data-plane-load-test/      # æ•°æ®é¢å‹æµ‹
â””â”€â”€ monitoring/                 # Prometheus + Grafana ç›‘æ§
    â”œâ”€â”€ prometheus/
    â””â”€â”€ grafana/
```

---

## å‰ç½®æ¡ä»¶

### Local æ¨¡å¼æ‰€éœ€

| å·¥å…· | è¯´æ˜ | å®‰è£…æ–¹å¼ |
|------|------|----------|
| **Go** | Go 1.21+ | [å®˜æ–¹ä¸‹è½½](https://go.dev/dl/) |
| **xk6** | k6 æ‰©å±•æ„å»ºå·¥å…· | `go install go.k6.io/xk6/cmd/xk6@latest` |

### Distributed æ¨¡å¼é¢å¤–æ‰€éœ€

| å·¥å…· | è¯´æ˜ | å®‰è£…æ–¹å¼ |
|------|------|----------|
| **kubectl** | Kubernetes CLI | [å®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/tasks/tools/) |
| **Kubernetes é›†ç¾¤** | 1.16+ ç‰ˆæœ¬ | - |
| **k6-operator** | k6 Kubernetes Operator | è§ä¸‹æ–‡å®‰è£…æ–¹æ³• |
| **å®¹å™¨ä»“åº“è®¿é—®æƒé™** | æ¨é€ k6 é•œåƒ | - |

---

## å¿«é€Ÿå¼€å§‹

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

#### å®‰è£… Go (å¦‚æœªå®‰è£…)

```bash
# macOS
brew install go

# éªŒè¯å®‰è£…
go version
```

#### å®‰è£… xk6

```bash
go install go.k6.io/xk6/cmd/xk6@latest

# éªŒè¯å®‰è£…
xk6 version
```

#### (ä»… Distributed æ¨¡å¼) å®‰è£… k6-operator

```bash
# ä½¿ç”¨å®˜æ–¹ bundle ä¸€é”®å®‰è£…åˆ° Kubernetes é›†ç¾¤
curl https://raw.githubusercontent.com/grafana/k6-operator/main/bundle.yaml | kubectl apply -f -

# éªŒè¯å®‰è£…
kubectl get pods -n k6-operator-system
```

---

### ç¬¬äºŒæ­¥ï¼šæ„å»º k6 (å« xk6-ags æ‰©å±•)

åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œï¼š

```bash
# æ„å»ºæœ¬åœ° k6 äºŒè¿›åˆ¶æ–‡ä»¶åˆ° _output/bin/k6
make build
```

æ„å»ºæˆåŠŸåï¼Œä½ ä¼šçœ‹åˆ° `_output/bin/k6` æ–‡ä»¶ã€‚

#### (ä»… Distributed æ¨¡å¼) æ„å»ºå¹¶æ¨é€ Docker é•œåƒ

```bash
# æ„å»ºé•œåƒ
make docker-build

# æ¨é€åˆ°ä»“åº“ (éœ€è¦å…ˆç™»å½•)
make docker-push

# æˆ–ä¸€æ­¥å®Œæˆ
make docker
```

> **æç¤º**: å¯é€šè¿‡ç¯å¢ƒå˜é‡è‡ªå®šä¹‰é•œåƒåœ°å€ï¼š
> ```bash
> IMAGE_REPO=your-registry/xk6-ags IMAGE_TAG=v1.0 make docker
> ```

---

### ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

è¿›å…¥ä½ è¦è¿è¡Œçš„æµ‹è¯•ç›®å½•ï¼Œä¾‹å¦‚ `tests/ags-control-panel-load-test/`ï¼š

```bash
cd tests/ags-control-panel-load-test/
```

å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹å¹¶å¡«å†™ï¼š

```bash
cp .env.example .env
```

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
# è…¾è®¯äº‘å‡­è¯ (å¿…å¡«)
TENCENTCLOUD_SECRET_ID=your-secret-id
TENCENTCLOUD_SECRET_KEY=your-secret-key
TENCENTCLOUD_REGION=ap-guangzhou

# AGS æœåŠ¡é…ç½®
AGS_HOST=ags.tencentcloudapi.com
AGS_DATA_PLANE_DOMAIN_SUFFIX=tencentags.com
```

---

### ç¬¬å››æ­¥ï¼šé…ç½®æµ‹è¯•å‚æ•°

å¤åˆ¶é…ç½®ç¤ºä¾‹ï¼š

```bash
cp config.example.js local/config.js
```

ç¼–è¾‘ `local/config.js`ï¼š

```javascript
export const config = {
    // AGS å·¥å…·åç§° (å¿…å¡«)
    toolName: 'your-tool-name',

    // å®ä¾‹è¶…æ—¶æ—¶é—´
    instanceTimeout: '5m',

    // å‹æµ‹å‚æ•°
    qps: 10,              // æ¯ç§’è¯·æ±‚æ•°
    duration: '30m',      // æµ‹è¯•æŒç»­æ—¶é—´
    preAllocatedVUs: 50,  // é¢„åˆ†é…è™šæ‹Ÿç”¨æˆ·æ•°
    maxVUs: 200,          // æœ€å¤§è™šæ‹Ÿç”¨æˆ·æ•°

    // é•œåƒåˆ—è¡¨ (å¯é€‰ï¼Œä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤é•œåƒ)
    images: [],
};
```

---

### ç¬¬äº”æ­¥ï¼šè¿è¡Œæµ‹è¯•

#### Local æ¨¡å¼

```bash
make local
```

#### Distributed æ¨¡å¼

```bash
make distributed
```

---

## Local vs Distributed æ¨¡å¼å¯¹æ¯”

| å¯¹æ¯”é¡¹ | ğŸ–¥ï¸ Local æ¨¡å¼ | â˜ï¸ Distributed æ¨¡å¼ |
|--------|---------------|---------------------|
| **è¿è¡Œç¯å¢ƒ** | æœ¬åœ°å•æœº | Kubernetes é›†ç¾¤ |
| **å¹¶å‘èƒ½åŠ›** | å—é™äºå•æœºèµ„æº | å¯æ°´å¹³æ‰©å±•åˆ°æ•°ç™¾ Pod |
| **é€‚ç”¨åœºæ™¯** | å¼€å‘è°ƒè¯•ã€å°è§„æ¨¡æµ‹è¯• | å¤§è§„æ¨¡å‹æµ‹ã€ç”Ÿäº§ç¯å¢ƒæµ‹è¯• |
| **èµ„æºæ¶ˆè€—** | æœ¬åœ° CPU/å†…å­˜ | é›†ç¾¤èµ„æºï¼ŒæŒ‰éœ€åˆ†é… |
| **ç»“æœæ”¶é›†** | ç»ˆç«¯è¾“å‡º | Prometheus + Grafana |
| **ä¾èµ–** | Go + xk6 | + Kubernetes + k6-operator |
| **å¯åŠ¨é€Ÿåº¦** | å¿«ï¼Œç§’çº§ | è¾ƒæ…¢ï¼Œéœ€ç­‰å¾… Pod è°ƒåº¦ |
| **è°ƒè¯•ä¾¿åˆ©** | æ–¹ä¾¿ï¼Œå¯æœ¬åœ°æ–­ç‚¹ | éœ€æŸ¥çœ‹ Pod æ—¥å¿— |

### å¦‚ä½•é€‰æ‹©ï¼Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¼€å§‹                                      â”‚
â”‚                          â”‚                                       â”‚
â”‚                    æ˜¯å¦åœ¨å¼€å‘è°ƒè¯•ï¼Ÿ                              â”‚
â”‚                     â•±         â•²                                  â”‚
â”‚                   æ˜¯            å¦                               â”‚
â”‚                   â”‚              â”‚                               â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”   éœ€è¦é«˜å¹¶å‘ï¼Ÿ                         â”‚
â”‚             â”‚  Local    â”‚    â•±      â•²                            â”‚
â”‚             â”‚   æ¨¡å¼    â”‚   æ˜¯       å¦                          â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚         â”‚                          â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â” â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                       â”‚Distributedâ”‚ â”‚  Local  â”‚                  â”‚
â”‚                       â”‚   æ¨¡å¼    â”‚ â”‚  æ¨¡å¼   â”‚                  â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## è¯¦ç»†ä½¿ç”¨æŒ‡å—

### Local æ¨¡å¼ (æœ¬åœ°å•æœº)

#### å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      æœ¬åœ°æœºå™¨                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  k6 (å« xk6-ags æ‰©å±•)                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚  â”‚   VU 1    â”‚ â”‚   VU 2    â”‚ â”‚   VU N    â”‚             â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â”‚        â”‚             â”‚             â”‚                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚           â”‚             â”‚             â”‚                      â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                         â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ HTTP/HTTPS
                          â–¼
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚    AGS æœåŠ¡        â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è¿è¡Œæ­¥éª¤

1. **è¿›å…¥æµ‹è¯•ç›®å½•**
   ```bash
   cd tests/ags-control-panel-load-test/
   ```

2. **é…ç½®ç¯å¢ƒ**
   ```bash
   # é…ç½®è…¾è®¯äº‘å‡­è¯
   cp .env.example .env
   vim .env

   # é…ç½®æµ‹è¯•å‚æ•°
   cp config.example.js local/config.js
   vim local/config.js
   ```

3. **è¿è¡Œæµ‹è¯•**
   ```bash
   make local
   ```

4. **æŸ¥çœ‹ç»“æœ**
   æµ‹è¯•ç»“æŸåï¼Œk6 ä¼šåœ¨ç»ˆç«¯è¾“å‡ºç»Ÿè®¡ä¿¡æ¯ï¼š
   ```
   âœ“ ags_start_success_ratio......: 99.50%
   âœ“ ags_start_duration...........: avg=1234ms min=500ms max=3000ms p(95)=2000ms
   ```

#### è‡ªå®šä¹‰ k6 è·¯å¾„

é»˜è®¤ä½¿ç”¨ `../../_output/bin/k6`ï¼Œå¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼š

```bash
K6_BIN=/usr/local/bin/k6 make local
```

---

### Distributed æ¨¡å¼ (åˆ†å¸ƒå¼é›†ç¾¤)

#### å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Kubernetes é›†ç¾¤                                  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  k6-operator    â”‚â”€â”€â”€â”€â–¶â”‚           TestRun CR                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  (parallelism: N)                        â”‚   â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                          â”‚                               â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚                    â”‚                     â”‚                     â”‚        â”‚
â”‚                    â–¼                     â–¼                     â–¼        â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚            â”‚  k6 Pod 1   â”‚       â”‚  k6 Pod 2   â”‚       â”‚  k6 Pod N   â”‚  â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚            â”‚  â”‚ VU 1-Mâ”‚  â”‚       â”‚  â”‚ VU 1-Mâ”‚  â”‚       â”‚  â”‚ VU 1-Mâ”‚  â”‚  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                   â”‚                     â”‚                     â”‚         â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                              â”‚                     â”‚                    â”‚
â”‚                              â–¼                     â–¼                    â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚                     â”‚   Prometheus    â”‚   â”‚    Grafana     â”‚            â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                          â”‚
                                          â”‚ HTTP/HTTPS
                                          â–¼
                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                               â”‚    AGS æœåŠ¡        â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### è¿è¡Œæ­¥éª¤

1. **ç¡®ä¿ k6-operator å·²å®‰è£…**
   ```bash
   kubectl get pods -n k6-operator-system
   # åº”çœ‹åˆ° k6-operator-controller-manager-xxx Running
   ```

2. **(å¯é€‰) éƒ¨ç½²ç›‘æ§ç»„ä»¶**
   ```bash
   cd monitoring/
   make install

   # éªŒè¯éƒ¨ç½²
   make status
   ```

3. **è¿›å…¥æµ‹è¯•ç›®å½•å¹¶é…ç½®**
   ```bash
   cd tests/ags-control-panel-load-test/

   # é…ç½®å‡­è¯
   cp .env.example .env
   vim .env

   # é…ç½®æµ‹è¯•å‚æ•°
   cp config.example.js local/config.js
   vim local/config.js
   ```

4. **é…ç½®åˆ†å¸ƒå¼å‚æ•°**

   ç¼–è¾‘ `distributed-config.yaml`ï¼š
   ```yaml
   apiVersion: v1
   kind: ConfigMap
   metadata:
     name: k6-distributed-config
   data:
     # Pod å¹¶è¡Œæ•° (æ ¸å¿ƒå‚æ•°ï¼)
     parallelism: "100"

     # k6 é•œåƒ (ç¡®ä¿å·²æ¨é€)
     image: "your-registry/xk6-ags:latest"

     # Prometheus åœ°å€
     prometheusUrl: "http://prometheus:9090/api/v1/write"

     # Runner èµ„æºé…ç½®
     cpuLimit: "1"
     cpuRequest: "1"
     memoryLimit: "2Gi"
     memoryRequest: "2Gi"
   ```

5. **è¿è¡Œåˆ†å¸ƒå¼æµ‹è¯•**
   ```bash
   make distributed
   ```

6. **æŸ¥çœ‹æµ‹è¯•çŠ¶æ€**
   ```bash
   # æŸ¥çœ‹ TestRun çŠ¶æ€
   kubectl get testrun

   # æŸ¥çœ‹ k6 Pod çŠ¶æ€
   kubectl get pods -l app=k6

   # æŸ¥çœ‹æŸä¸ª Pod çš„æ—¥å¿—
   kubectl logs -f <pod-name>
   ```

7. **æŸ¥çœ‹ Grafana ä»ªè¡¨æ¿**
   ```bash
   # ç«¯å£è½¬å‘
   cd monitoring/
   make port-forward

   # æµè§ˆå™¨æ‰“å¼€
   # Prometheus: http://localhost:9090
   # Grafana: http://localhost:3000 (admin/admin)
   ```

8. **æ¸…ç†èµ„æº**
   ```bash
   make clean
   ```

#### å…³é”®é…ç½®è¯´æ˜

##### parallelism (Pod å¹¶è¡Œæ•°)

è¿™æ˜¯åˆ†å¸ƒå¼æ¨¡å¼æœ€é‡è¦çš„å‚æ•°ã€‚è®¾ç½®åˆç†çš„å€¼éœ€è¦è€ƒè™‘ï¼š

- **QPS ç›®æ ‡**: å‡è®¾å•ä¸ª VU èƒ½äº§ç”Ÿ ~1 QPSï¼Œåˆ™éœ€è¦ `parallelism Ã— VUs_per_pod â‰¥ ç›®æ ‡ QPS`
- **é›†ç¾¤å®¹é‡**: ä¸è¦è¶…è¿‡é›†ç¾¤å¯è°ƒåº¦çš„ Pod æ•°
- **èµ„æºé™åˆ¶**: æ¯ä¸ª Pod ä¼šæ¶ˆè€—é…ç½®çš„ CPU/å†…å­˜

ç¤ºä¾‹è®¡ç®—ï¼š
```
ç›®æ ‡ QPS: 1000
æ¯ Pod VU æ•°: 50 (ç”± maxVUs å†³å®š)
æ‰€éœ€ parallelism: 1000 / 50 = 20
```

##### Runner èµ„æºé…ç½®

æ ¹æ®æµ‹è¯•è„šæœ¬å¤æ‚åº¦è°ƒæ•´ï¼š

| åœºæ™¯ | CPU | å†…å­˜ |
|------|-----|------|
| ç®€å• HTTP æµ‹è¯• | 0.5 | 512Mi |
| å«å¤æ‚é€»è¾‘ | 1 | 1Gi |
| å¤§é‡æ•°æ®å¤„ç† | 2 | 2Gi |

---

## å¯ç”¨çš„æµ‹è¯•ç”¨ä¾‹

| ç›®å½• | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `tests/helloworld/` | å…¥é—¨ç¤ºä¾‹ | éªŒè¯ç¯å¢ƒæ­å»º |
| `tests/ags-control-panel-load-test/` | AGS æ§åˆ¶é¢å‹æµ‹ | æµ‹è¯•å®ä¾‹åˆ›å»º/é”€æ¯ |
| `tests/ags-data-plane-load-test/` | AGS æ•°æ®é¢å‹æµ‹ | æµ‹è¯•å®ä¾‹æ‰§è¡Œå‘½ä»¤ |
| `tests/swe-test/` | SWE-bench åœºæ™¯ | ç»¼åˆæµ‹è¯• |

### helloworld ç¤ºä¾‹

æœ€ç®€å•çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç”¨äºéªŒè¯ç¯å¢ƒï¼š

```bash
cd tests/helloworld/

# Local æ¨¡å¼ (æ— éœ€é…ç½®)
make local

# Distributed æ¨¡å¼
make distributed
```

---

## ç›‘æ§ä¸å¯è§†åŒ–

### éƒ¨ç½²ç›‘æ§æ ˆ

```bash
cd monitoring/

# ä¸€é”®éƒ¨ç½² Prometheus + Grafana
make install

# ç«¯å£è½¬å‘
make port-forward
```

### Grafana ä»ªè¡¨æ¿

é¡¹ç›®å†…ç½®ä»¥ä¸‹ä»ªè¡¨æ¿ï¼š

| ä»ªè¡¨æ¿ | ç”¨é€” |
|--------|------|
| k6-dashboard.json | k6 é€šç”¨æŒ‡æ ‡ |
| ags-control-panel-dashboard.json | æ§åˆ¶é¢æŒ‡æ ‡ |
| ags-data-plane-dashboard.json | æ•°æ®é¢æŒ‡æ ‡ |

### å¸è½½ç›‘æ§

```bash
cd monitoring/
make uninstall
```

---

## å¸¸è§é—®é¢˜

### Q: Local æ¨¡å¼è¿è¡ŒæŠ¥é”™ "k6: command not found"

**A**: ç¡®ä¿å·²æ„å»º k6 å¹¶æŒ‡å®šæ­£ç¡®è·¯å¾„ï¼š

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ„å»º
make build

# æˆ–æŒ‡å®šè‡ªå®šä¹‰è·¯å¾„
K6_BIN=/path/to/k6 make local
```

### Q: Distributed æ¨¡å¼ Pod ä¸€ç›´ Pending

**A**: æ£€æŸ¥é›†ç¾¤èµ„æºæ˜¯å¦å……è¶³ï¼š

```bash
kubectl describe pod <pod-name>
# æŸ¥çœ‹ Events éƒ¨åˆ†çš„é”™è¯¯ä¿¡æ¯
```

å¸¸è§åŸå› ï¼š
- é›†ç¾¤èµ„æºä¸è¶³ï¼Œé™ä½ `parallelism` æˆ–è°ƒå°èµ„æºè¯·æ±‚
- é•œåƒæ‹‰å–å¤±è´¥ï¼Œæ£€æŸ¥é•œåƒåœ°å€å’Œæ‹‰å–æƒé™

### Q: å¦‚ä½•è‡ªå®šä¹‰ k6 é•œåƒï¼Ÿ

**A**: ä¿®æ”¹æ ¹ç›®å½• `Makefile` ä¸­çš„é•œåƒåœ°å€ï¼š

```bash
IMAGE_REPO=your-registry/xk6-ags IMAGE_TAG=v1.0 make docker
```

ç„¶åæ›´æ–° `distributed-config.yaml` ä¸­çš„ `image` å­—æ®µã€‚

### Q: Prometheus æ— æ•°æ®

**A**: æ£€æŸ¥ä»¥ä¸‹å‡ ç‚¹ï¼š

1. Prometheus æ˜¯å¦æ­£å¸¸è¿è¡Œ
   ```bash
   kubectl get pods -l app=prometheus
   ```

2. k6 Pod æ˜¯å¦é…ç½®äº†æ­£ç¡®çš„ Prometheus åœ°å€
   ```bash
   kubectl get testrun -o yaml | grep K6_PROMETHEUS
   ```

3. ç½‘ç»œæ˜¯å¦å¯è¾¾
   ```bash
   kubectl exec -it <k6-pod> -- wget -qO- http://prometheus:9090/-/healthy
   ```

### Q: å¦‚ä½•åœæ­¢æ­£åœ¨è¿è¡Œçš„åˆ†å¸ƒå¼æµ‹è¯•ï¼Ÿ

**A**:

```bash
# åˆ é™¤ TestRun èµ„æº
kubectl delete testrun <testrun-name>

# æˆ–ä½¿ç”¨ Makefile
make clean
```

---

## æ›´å¤šèµ„æº

- [k6 å®˜æ–¹æ–‡æ¡£](https://grafana.com/docs/k6/latest/)
- [k6-operator æ–‡æ¡£](https://grafana.com/docs/k6/latest/set-up/set-up-distributed-k6/)
- [xk6 æ‰©å±•å¼€å‘](https://grafana.com/docs/k6/latest/extensions/)
